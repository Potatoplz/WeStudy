<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="StudyMapper">

	<insert id="recruit" parameterType="kr.co.westudy.study.StudyDTO" useGeneratedKeys="true" keyProperty="study_id">
		insert into study_recruit (study_team, study_name, study_type, recruit_cnt, study_onoff, study_city, view_cnt,
									start_date, end_date, study_content, study_writedate, member_id, member_nick)
		values (#{study_team}, #{study_name}, #{study_type}, #{recruit_cnt}, #{study_onoff}, #{study_city}, 0,
				#{start_date}, #{end_date}, #{study_content}, now(), #{member_id}, #{member_nick})
	</insert>

	<select id="teamNameCheck" parameterType="java.lang.String" resultType="int">
		select count(study_team) cnt
		from study_recruit
		where study_team = #{study_team}
	</select>
	
	<select id="studylist" parameterType="kr.co.westudy.study.StudyDTO" resultType="kr.co.westudy.study.StudyDTO">
		select study_id,study_team, study_name, study_type, recruit_cnt, study_onoff, study_city, view_cnt, 
				start_date, end_date, study_content, study_writedate, study_state, member_id, member_nick
		from study_recruit
		order by study_id desc
		limit ${limit_cnt}, 12
	</select>
	
	<select id="apply_cnt" parameterType="kr.co.westudy.study.StudyDTO" resultType="int">
		select count(study_id) cnt
		from study_apply
		where study_id = #{study_id} and member_id = #{member_id}
	</select>
	
	<select id="mystudylist" parameterType="kr.co.westudy.study.StudyDTO" resultType="kr.co.westudy.study.StudyDTO">
		select study_id, study_team, study_name, study_type, recruit_cnt, study_onoff, study_city, view_cnt, 
				start_date, end_date, study_content, study_writedate, study_state, member_id, member_nick
				from study_recruit
				where member_id = #{member_id};
	</select>
	
	<select id="applymember" parameterType="java.lang.String" resultType="kr.co.westudy.study.StudyDTO">
		select apply_id, study_id, member_id, member_nick, apply_content, accept_yn
				from study_apply
				where study_id = #{study_id};
	</select>
	
	<select id="applylist" parameterType="kr.co.westudy.study.StudyDTO" resultType="kr.co.westudy.study.StudyDTO">
		select sa.study_id, sr.study_team, sr.study_name, sr.study_type, sr.recruit_cnt, sr.study_onoff, sr.study_city, sr.view_cnt, 
				sr.start_date, sr.end_date, sr.study_content, sr.study_writedate, sr.study_state, sr.member_id, sr.member_nick,
				sa.apply_content, sa.accept_yn
				from study_recruit sr, study_apply sa
				where sa.member_id = #{member_id} and sa.study_id = sr.study_id;
	</select>
	
	<update id="incrementViewCnt" parameterType="java.lang.String">
		update study_recruit
		set view_cnt = view_cnt + 1
		where study_id = #{study_id}
	</update>

	<select id="detail" parameterType="java.lang.String" resultType="kr.co.westudy.study.StudyDTO">
		select re.study_id, re.study_team, re.study_name, re.study_type, re.recruit_cnt, re.study_onoff
				, re.study_city, re.view_cnt, re.start_date, re.end_date, re.study_content, re.study_writedate
				, re.study_state, re.member_id, re.member_nick
		from study_recruit re, member m
		where re.study_id = #{study_id}
		and re.member_id = m.member_id
	</select>
	
	<delete id="delete" parameterType="kr.co.westudy.study.StudyDTO">
		delete from study_recruit
		where study_id = #{study_id}
		and member_id = #{member_id}
	</delete>
	
	<insert id="apply_insert" parameterType="kr.co.westudy.study.StudyDTO">
	INSERT INTO study_apply (study_id, member_id, member_nick, apply_content) 
		select #{study_id}, #{member_id}, #{member_nick}, #{apply_content}
	</insert>
	
	<delete id="apply_cancel" parameterType="kr.co.westudy.study.StudyDTO">
		delete from study_apply
		where study_id = #{study_id}
		and member_id = #{member_id}
	</delete>
	
	
</mapper>